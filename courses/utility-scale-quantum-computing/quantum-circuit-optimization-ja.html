
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>量子回路の最適化 &#8212; Quantum Tokyo</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'courses/utility-scale-quantum-computing/quantum-circuit-optimization-ja';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo.png" class="logo__image only-light" alt="Quantum Tokyo - Home"/>
    <script>document.write(`<img src="../../_static/logo.png" class="logo__image only-dark" alt="Quantum Tokyo - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../intro.html">
                    Quantum Tokyo へようこそ
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">学習コンテンツ</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../get_started.html">Qiskit の始め方</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../iqp_documents.html">IBM Quantum Plaform 教材 日本語訳</a></li>
<li class="toctree-l1"><a class="reference external" href="https://quantum-tokyo.github.io/introduction/courses/utility-scale-quantum-computing/overview-ja.html">ユーティリティー・スケール量子コンピューティング</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ibm_research_blog.html">IBM Research Blog 日本語版</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../qiskit_textbook_ja.html">(旧) Qiskitテキストブック 日本語版</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../qiskit_textbook_new_ja.html">(旧)Qiskitテキストブック(Qiskitコース) 日本語版</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../qiskit_documents_ja.html">(旧) Qiskitドキュメント・チュートリアル 日本語版リンク集</a></li>
<li class="toctree-l1"><a class="reference external" href="https://quantum-tokyo.github.io/ibm-quantum-challenge-textbook/intro.html">IBM Quantum Challenge</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../qgss_ja.html">Qiskit Global Summer School （Qiskit夏の学校） 資料 日本語版</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quantum_tokyo_materials.html">Quantum Tokyo 過去イベント資料</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../events.html">Qiskitコミュニティー関連イベント案内</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools.html">その他： IBM Quantum の便利なツール</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/quantum-tokyo/introduction" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/quantum-tokyo/introduction/issues/new?title=Issue%20on%20page%20%2Fcourses/utility-scale-quantum-computing/quantum-circuit-optimization-ja.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/courses/utility-scale-quantum-computing/quantum-circuit-optimization-ja.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>量子回路の最適化</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">1. はじめに</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">2. 回路最適化の重要性</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">2.1 最適化レベル</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">2.2 演習</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">3. 回路合成の重要性</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#qiskit">3.1 Qiskitトランスパイル全体の流れを描画</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">3.2 個別ステージの描画</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">3.3 演習</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">3.4 最適化ステージ</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">4. 詳細な例</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id11">4.1 2量子ビットブロック最適化（2量子ビットユニタリー合成）</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id12">4.2 回路最適化の重要性</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id13">4.3 回路合成の重要性</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id14">4.4 一般的な1量子ビットゲート分解</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id15">4.5 1量子ビットブロック最適化</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id16">4.6 トフォリ分解</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cu">4.7 CUゲート分解</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cx-ecr-czclifford">4.8 CX, ECR, CZはローカルClifford変換で等価</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="id1">
<h1>量子回路の最適化<a class="headerlink" href="#id1" title="Link to this heading">#</a></h1>
<Admonition type="note">
  Toshinari Itoko (21 June 2024), Translated by Daiki Murata
<p>和訳版の講義スライドPDFは<a class="reference external" href="https://github.com/quantum-tokyo/introduction/blob/main/src/courses/utility-scale-quantum-computing/10_quantum-circuit-optimization.pdf">こちら</a>です。
<em>この実験をQPUで実行するのに必要なおおよその時間は15秒です。</em></p>
<p>（注：パート2の一部セルは “Qiskit Deep dive” ノートブックから引用しています。著者は Matthew Treinish（Qiskit管理者）です）
</Admonition></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># !pip install &#39;qiskit[visualization]&#39;</span>
<span class="c1"># !pip install qiskit_ibm_runtime qiskit_aer</span>
<span class="c1"># !pip install jupyter</span>
<span class="c1"># !pip install matplotlib pylatexenc pydot pillow</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">qiskit</span>

<span class="n">qiskit</span><span class="o">.</span><span class="n">__version__</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;2.1.1&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">qiskit_ibm_runtime</span>

<span class="n">qiskit_ibm_runtime</span><span class="o">.</span><span class="n">__version__</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;0.41.0&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">qiskit_aer</span>

<span class="n">qiskit_aer</span><span class="o">.</span><span class="n">__version__</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;0.17.1&#39;
</pre></div>
</div>
</div>
</div>
<section id="id2">
<h2>1. はじめに<a class="headerlink" href="#id2" title="Link to this heading">#</a></h2>
<p>このレッスンでは、量子コンピューティングにおける回路最適化のさまざまな側面について説明します。まず、Qiskitに組み込まれている最適化設定を使って回路最適化の価値を確認します。次に、特定の応用分野の専門家として、賢く回路を構築する方法を少し掘り下げて学びます。最後に、トランスパイル時に回路がどのように最適化されるかを詳しく見ていきます。</p>
</section>
<section id="id3">
<h2>2. 回路最適化の重要性<a class="headerlink" href="#id3" title="Link to this heading">#</a></h2>
<p>まず、最適化あり・なしで5量子ビットGHZ状態（<span class="math notranslate nohighlight">\(\frac{1}{\sqrt{2}} \left( |00000\rangle + |11111\rangle \right)\)</span>）生成回路の実行結果を比較します。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">qiskit.circuit</span><span class="w"> </span><span class="kn">import</span> <span class="n">QuantumCircuit</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">qiskit.transpiler.preset_passmanagers</span><span class="w"> </span><span class="kn">import</span> <span class="n">generate_preset_pass_manager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">qiskit.primitives</span><span class="w"> </span><span class="kn">import</span> <span class="n">BackendSamplerV2</span> <span class="k">as</span> <span class="n">Sampler</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">qiskit_ibm_runtime.fake_provider</span><span class="w"> </span><span class="kn">import</span> <span class="n">FakeKyiv</span>

<span class="n">backend</span> <span class="o">=</span> <span class="n">FakeKyiv</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>まず、以下のように素朴に合成したGHZ回路を使います。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_qubits</span> <span class="o">=</span> <span class="mi">5</span>

<span class="n">ghz_circ</span> <span class="o">=</span> <span class="n">QuantumCircuit</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">)</span>
<span class="n">ghz_circ</span><span class="o">.</span><span class="n">h</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="p">[</span><span class="n">ghz_circ</span><span class="o">.</span><span class="n">cx</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_qubits</span><span class="p">)]</span>
<span class="n">ghz_circ</span><span class="o">.</span><span class="n">measure_all</span><span class="p">()</span>
<span class="n">ghz_circ</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="s2">&quot;mpl&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/328007675e4984199d0155c55e78f87cd4169480556e7493a3b5295977b428ac.png" src="../../_images/328007675e4984199d0155c55e78f87cd4169480556e7493a3b5295977b428ac.png" />
</div>
</div>
<section id="id4">
<h3>2.1 最適化レベル<a class="headerlink" href="#id4" title="Link to this heading">#</a></h3>
<p>最適化レベル <code class="docutils literal notranslate"><span class="pre">optimization_level</span></code> は 0〜3 の4段階があります。最適化レベルが高いほど、回路最適化により多くの計算リソースが使われます。レベル0は最適化を行わず、選択したバックエンドで回路を実行可能にするための最低限の処理のみ行います。レベル3は最も多くの労力（通常は実行時間も長い）をかけて回路を最適化します。レベル1がデフォルトです。</p>
<p>回路を最適化なし（<code class="docutils literal notranslate"><span class="pre">optimization_level=0</span></code>）と最適化あり（<code class="docutils literal notranslate"><span class="pre">optimization_level=2</span></code>）でトランスパイルします。
トランスパイル後の回路長に大きな違いがあることが分かります。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pm0</span> <span class="o">=</span> <span class="n">generate_preset_pass_manager</span><span class="p">(</span>
    <span class="n">optimization_level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">,</span> <span class="n">seed_transpiler</span><span class="o">=</span><span class="mi">777</span>
<span class="p">)</span>
<span class="n">pm2</span> <span class="o">=</span> <span class="n">generate_preset_pass_manager</span><span class="p">(</span>
    <span class="n">optimization_level</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">,</span> <span class="n">seed_transpiler</span><span class="o">=</span><span class="mi">777</span>
<span class="p">)</span>
<span class="n">circ0</span> <span class="o">=</span> <span class="n">pm0</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">ghz_circ</span><span class="p">)</span>
<span class="n">circ2</span> <span class="o">=</span> <span class="n">pm2</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">ghz_circ</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;optimization_level=0:&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">circ0</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="s2">&quot;mpl&quot;</span><span class="p">,</span> <span class="n">idle_wires</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fold</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;optimization_level=2:&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">circ2</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="s2">&quot;mpl&quot;</span><span class="p">,</span> <span class="n">idle_wires</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fold</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>optimization_level=0:
</pre></div>
</div>
<img alt="../../_images/792022ef5e0ab9d38fec45e9be115935755855b8122c3fc2c7218064f649d7ad.png" src="../../_images/792022ef5e0ab9d38fec45e9be115935755855b8122c3fc2c7218064f649d7ad.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>optimization_level=2:
</pre></div>
</div>
<img alt="../../_images/e15e2dac5bf06ae5214e518379156ed4b1b9a57765bc351bff629d1e9150a31d.png" src="../../_images/e15e2dac5bf06ae5214e518379156ed4b1b9a57765bc351bff629d1e9150a31d.png" />
</div>
</div>
</section>
<section id="id5">
<h3>2.2 演習<a class="headerlink" href="#id5" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">optimization_level=1</span></code>も試して、上記2つと結果を比較してください。上のコードを修正して試してみましょう。</p>
<p><strong>解答例:</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pm1</span> <span class="o">=</span> <span class="n">generate_preset_pass_manager</span><span class="p">(</span>
    <span class="n">optimization_level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">,</span> <span class="n">seed_transpiler</span><span class="o">=</span><span class="mi">777</span>
<span class="p">)</span>
<span class="n">circ1</span> <span class="o">=</span> <span class="n">pm1</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">ghz_circ</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;optimization_level=1:&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">circ1</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="s2">&quot;mpl&quot;</span><span class="p">,</span> <span class="n">idle_wires</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fold</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>optimization_level=1:
</pre></div>
</div>
<img alt="../../_images/4e2550e3d899056187a1aa39194a8c6e959bf7681f20587b7d89c0e58bad3745.png" src="../../_images/4e2550e3d899056187a1aa39194a8c6e959bf7681f20587b7d89c0e58bad3745.png" />
</div>
</div>
<p>フェイクバックエンド（ノイズ付きシミュレーター）で実行します。実機での実行方法は付録1を参照してください。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># run the circuits on the fake backend (noisy simulator)</span>
<span class="n">sampler</span> <span class="o">=</span> <span class="n">Sampler</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">)</span>
<span class="n">job</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">circ0</span><span class="p">,</span> <span class="n">circ2</span><span class="p">],</span> <span class="n">shots</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job ID: </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Job ID: d510d781-b2a0-450e-904a-540a618373b0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># get results</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
<span class="n">unoptimized_result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">meas</span><span class="o">.</span><span class="n">get_counts</span><span class="p">()</span>
<span class="n">optimized_result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">meas</span><span class="o">.</span><span class="n">get_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">qiskit.visualization</span><span class="w"> </span><span class="kn">import</span> <span class="n">plot_histogram</span>

<span class="c1"># plot</span>
<span class="n">sim_result</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;0&quot;</span> <span class="o">*</span> <span class="mi">5</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span> <span class="o">*</span> <span class="mi">5</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">}</span>
<span class="n">plot_histogram</span><span class="p">(</span>
    <span class="p">[</span><span class="n">result</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="p">[</span><span class="n">sim_result</span><span class="p">,</span> <span class="n">unoptimized_result</span><span class="p">,</span> <span class="n">optimized_result</span><span class="p">]],</span>
    <span class="n">bar_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">legend</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;ideal&quot;</span><span class="p">,</span>
        <span class="s2">&quot;no optimization&quot;</span><span class="p">,</span>
        <span class="s2">&quot;with optimization&quot;</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/d8da77a71181483058b83602cabde468b830947041437ba3a780df0672fa99d6.png" src="../../_images/d8da77a71181483058b83602cabde468b830947041437ba3a780df0672fa99d6.png" />
</div>
</div>
</section>
</section>
<section id="id6">
<h2>3. 回路合成の重要性<a class="headerlink" href="#id6" title="Link to this heading">#</a></h2>
<p>次に、2通りの合成方法で作った5量子ビットGHZ状態（<span class="math notranslate nohighlight">\(\frac{1}{\sqrt{2}} \left( |00000\rangle + |11111\rangle \right)\)</span>）生成回路の実行結果を比較します。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Original GHZ circuit (naive synthesis)</span>
<span class="n">ghz_circ</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="s2">&quot;mpl&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/328007675e4984199d0155c55e78f87cd4169480556e7493a3b5295977b428ac.png" src="../../_images/328007675e4984199d0155c55e78f87cd4169480556e7493a3b5295977b428ac.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># A cleverly-synthesized GHZ circuit</span>
<span class="n">ghz_circ2</span> <span class="o">=</span> <span class="n">QuantumCircuit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">ghz_circ2</span><span class="o">.</span><span class="n">h</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ghz_circ2</span><span class="o">.</span><span class="n">cx</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">ghz_circ2</span><span class="o">.</span><span class="n">cx</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">ghz_circ2</span><span class="o">.</span><span class="n">cx</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">ghz_circ2</span><span class="o">.</span><span class="n">cx</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">ghz_circ2</span><span class="o">.</span><span class="n">measure_all</span><span class="p">()</span>
<span class="n">ghz_circ2</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="s2">&quot;mpl&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/0c607532f8d71c5ffa4a644dae59290e28197fee4bceacb0d750a031b0955929.png" src="../../_images/0c607532f8d71c5ffa4a644dae59290e28197fee4bceacb0d750a031b0955929.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># transpile both with the same optimization level 2</span>
<span class="n">circ_org</span> <span class="o">=</span> <span class="n">pm2</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">ghz_circ</span><span class="p">)</span>
<span class="n">circ_new</span> <span class="o">=</span> <span class="n">pm2</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">ghz_circ2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;original synthesis:&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">circ_org</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="s2">&quot;mpl&quot;</span><span class="p">,</span> <span class="n">idle_wires</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fold</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;new synthesis:&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">circ_new</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="s2">&quot;mpl&quot;</span><span class="p">,</span> <span class="n">idle_wires</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fold</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>original synthesis:
</pre></div>
</div>
<img alt="../../_images/e15e2dac5bf06ae5214e518379156ed4b1b9a57765bc351bff629d1e9150a31d.png" src="../../_images/e15e2dac5bf06ae5214e518379156ed4b1b9a57765bc351bff629d1e9150a31d.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>new synthesis:
</pre></div>
</div>
<img alt="../../_images/c7fa28574b28375c65790fbfead9ac22adb220006bb1fddd8e4dffe3e914de2b.png" src="../../_images/c7fa28574b28375c65790fbfead9ac22adb220006bb1fddd8e4dffe3e914de2b.png" />
</div>
</div>
<p>新しい合成方法では、より浅い回路が得られます。なぜでしょうか？</p>
<p>新しい回路は線形に接続された量子ビット上に配置できるため、IBM® Kyivのheavy-hexagon結合グラフでも配置可能です。一方、元の回路は星型（次数4のノード）接続が必要で、heavy-hex結合グラフ（最大次数3）には直接配置できません。そのため、元の回路ではSWAPゲートによるルーティングが必要となり、ゲート数が増加します。</p>
<p>新しい回路合成は「結合制約を考慮した回路合成」を手動で行った例です。つまり、回路合成と回路マッピングを同時に手動で解決しています。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># run the circuits</span>
<span class="n">sampler</span> <span class="o">=</span> <span class="n">Sampler</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">)</span>
<span class="n">job</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">circ_org</span><span class="p">,</span> <span class="n">circ_new</span><span class="p">],</span> <span class="n">shots</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job ID: </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Job ID: 0cbb94c5-9202-44e5-a6e3-a8a7ce31b440
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># get results</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
<span class="n">synthesis_org_result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">meas</span><span class="o">.</span><span class="n">get_counts</span><span class="p">()</span>
<span class="n">synthesis_new_result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">meas</span><span class="o">.</span><span class="n">get_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot</span>
<span class="n">sim_result</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;0&quot;</span> <span class="o">*</span> <span class="mi">5</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span> <span class="o">*</span> <span class="mi">5</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">}</span>
<span class="n">plot_histogram</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">result</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="n">sim_result</span><span class="p">,</span>
            <span class="n">unoptimized_result</span><span class="p">,</span>
            <span class="n">synthesis_org_result</span><span class="p">,</span>
            <span class="n">synthesis_new_result</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">],</span>
    <span class="n">bar_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">legend</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;ideal&quot;</span><span class="p">,</span>
        <span class="s2">&quot;no optimization&quot;</span><span class="p">,</span>
        <span class="s2">&quot;synthesis_org&quot;</span><span class="p">,</span>
        <span class="s2">&quot;synthesis_new&quot;</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/45412464ffb397aa383918bd146a79f8784368dde3a554892abdc469ab1f92a3.png" src="../../_images/45412464ffb397aa383918bd146a79f8784368dde3a554892abdc469ab1f92a3.png" />
</div>
</div>
<p>一般に、回路合成はアプリケーションによって異なり、すべてのアプリケーションをソフトウェアでカバーするのは困難です。QiskitのトランスパイラにはGHZ状態生成回路の合成機能はありません。このような場合、上記のような手動回路合成が有効です。</p>
<p>このセクションでは、Qiskitトランスパイラがどのように動作するかを、以下のおもちゃの回路例を使って詳しく見ていきます。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Build a toy example circuit</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">math</span><span class="w"> </span><span class="kn">import</span> <span class="n">pi</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">qiskit.circuit</span><span class="w"> </span><span class="kn">import</span> <span class="n">QuantumCircuit</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">qiskit.circuit.library</span><span class="w"> </span><span class="kn">import</span> <span class="n">excitation_preserving</span>

<span class="n">circuit</span> <span class="o">=</span> <span class="n">QuantumCircuit</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Example circuit&quot;</span><span class="p">)</span>
<span class="n">circuit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">excitation_preserving</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">reps</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
<span class="n">circuit</span><span class="o">.</span><span class="n">measure_all</span><span class="p">()</span>

<span class="n">value_cycle</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">cycle</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="n">pi</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span><span class="p">])</span>
<span class="n">circuit</span><span class="o">.</span><span class="n">assign_parameters</span><span class="p">(</span>
    <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">circuit</span><span class="o">.</span><span class="n">parameters</span><span class="p">)),</span> <span class="n">value_cycle</span><span class="p">)],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">circuit</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="s2">&quot;mpl&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/9a55ab96a09d8d52bc2d929ac0be94cea17045b54cf52401d75013556f095f32.png" src="../../_images/9a55ab96a09d8d52bc2d929ac0be94cea17045b54cf52401d75013556f095f32.png" />
</div>
</div>
<section id="qiskit">
<h3>3.1 Qiskitトランスパイル全体の流れを描画<a class="headerlink" href="#qiskit" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">optimization_level=1</span></code>のトランスパイラパス（タスク）を見ていきます。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">qiskit.transpiler.preset_passmanagers</span><span class="w"> </span><span class="kn">import</span> <span class="n">generate_preset_pass_manager</span>

<span class="c1"># There is no need to read this entire image, but this outputs all the steps in the transpile() call</span>
<span class="c1"># for optimization level 1</span>
<span class="n">pm</span> <span class="o">=</span> <span class="n">generate_preset_pass_manager</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">backend</span><span class="p">,</span> <span class="n">seed_transpiler</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">pm</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/f0d923adebc868bd6c2a285f9b03bf1b11715771f24fb85d9a73438316372517.png" src="../../_images/f0d923adebc868bd6c2a285f9b03bf1b11715771f24fb85d9a73438316372517.png" />
</div>
</div>
<p>フローは6つのステージで構成されています：</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">stages</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;init&#39;, &#39;layout&#39;, &#39;routing&#39;, &#39;translation&#39;, &#39;optimization&#39;, &#39;scheduling&#39;)
</pre></div>
</div>
</div>
</div>
</section>
<section id="id7">
<h3>3.2 個別ステージの描画<a class="headerlink" href="#id7" title="Link to this heading">#</a></h3>
<p>まず、<code class="docutils literal notranslate"><span class="pre">init</span></code>ステージで実行されるすべてのタスク（トランスパイラパス）を描画します。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pm</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/451c4fa1cd6c481c37a735f59701b4243613f8401eaa936dab29f2a676f9f717.png" src="../../_images/451c4fa1cd6c481c37a735f59701b4243613f8401eaa936dab29f2a676f9f717.png" />
</div>
</div>
<p>各ステージは個別に実行できます。<code class="docutils literal notranslate"><span class="pre">init</span></code>ステージを回路に対して実行してみましょう。ロガーを有効にすると、実行の詳細が表示されます。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="s2">&quot;INFO&quot;</span><span class="p">)</span>

<span class="n">init_out</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">circuit</span><span class="p">)</span>
<span class="n">init_out</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="s2">&quot;mpl&quot;</span><span class="p">,</span> <span class="n">fold</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:qiskit.passmanager.base_tasks:Pass: UnitarySynthesis - 0.02289 (ms)
INFO:qiskit.passmanager.base_tasks:Pass: HighLevelSynthesis - 0.16689 (ms)
INFO:qiskit.passmanager.base_tasks:Pass: BasisTranslator - 0.06390 (ms)
INFO:qiskit.passmanager.base_tasks:Pass: InverseCancellation - 0.24319 (ms)
INFO:qiskit.passmanager.base_tasks:Pass: ContractIdleWiresInControlFlow - 0.00691 (ms)
</pre></div>
</div>
<img alt="../../_images/16c361faf918db25332a0e8a11cd179533c0a6e45721bbe340395b05573a866b.png" src="../../_images/16c361faf918db25332a0e8a11cd179533c0a6e45721bbe340395b05573a866b.png" />
</div>
</div>
</section>
<section id="id8">
<h3>3.3 演習<a class="headerlink" href="#id8" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">layout</span></code>ステージのパスを描画し、<code class="docutils literal notranslate"><span class="pre">init</span></code>ステージの出力回路（<code class="docutils literal notranslate"><span class="pre">init_out</span></code>）に対してステージを実行してください。上記セルを修正して実施します。</p>
<p><strong>解答例:</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">draw</span><span class="p">())</span>
<span class="n">layout_out</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">init_out</span><span class="p">)</span>
<span class="n">layout_out</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="s2">&quot;mpl&quot;</span><span class="p">,</span> <span class="n">idle_wires</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fold</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/0c3962e3b09375d59aa55ea193caf4e77b05d4616a1fd994a01f49b02bcb8c24.png" src="../../_images/0c3962e3b09375d59aa55ea193caf4e77b05d4616a1fd994a01f49b02bcb8c24.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:qiskit.passmanager.base_tasks:Pass: SetLayout - 0.00525 (ms)
INFO:qiskit.passmanager.base_tasks:Pass: TrivialLayout - 0.03195 (ms)
INFO:qiskit.passmanager.base_tasks:Pass: CheckMap - 0.04673 (ms)
INFO:qiskit.passmanager.base_tasks:Pass: VF2Layout - 0.48399 (ms)
INFO:qiskit.passmanager.base_tasks:Pass: BarrierBeforeFinalMeasurements - 0.01574 (ms)
INFO:qiskit.passmanager.base_tasks:Pass: SabreLayout - 2.44880 (ms)
</pre></div>
</div>
<img alt="../../_images/cd46071c2c97dbd642ff973c70c1508c344a0899e29df9697fea8cd6637c35af.png" src="../../_images/cd46071c2c97dbd642ff973c70c1508c344a0899e29df9697fea8cd6637c35af.png" />
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">translation</span></code>ステージでも同様に実施してください。</p>
<p><strong>解答例:</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">translation</span><span class="o">.</span><span class="n">draw</span><span class="p">())</span>
<span class="n">basis_out</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">translation</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">layout_out</span><span class="p">)</span>
<span class="n">basis_out</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="s2">&quot;mpl&quot;</span><span class="p">,</span> <span class="n">idle_wires</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fold</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/aa866a2f90e5f975aaa05ac7f0f79e7f8ef740792c351f2d339896930273ef0e.png" src="../../_images/aa866a2f90e5f975aaa05ac7f0f79e7f8ef740792c351f2d339896930273ef0e.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:qiskit.passmanager.base_tasks:Pass: UnitarySynthesis - 0.01097 (ms)
INFO:qiskit.passmanager.base_tasks:Pass: HighLevelSynthesis - 0.11706 (ms)
INFO:qiskit.passmanager.base_tasks:Pass: BasisTranslator - 1.09696 (ms)
INFO:qiskit.passmanager.base_tasks:Pass: CheckGateDirection - 0.01287 (ms)
INFO:qiskit.passmanager.base_tasks:Pass: GateDirection - 0.09918 (ms)
INFO:qiskit.passmanager.base_tasks:Pass: BasisTranslator - 0.42319 (ms)
</pre></div>
</div>
<img alt="../../_images/e3986286fc17a8d4530a0e8e143ef96054f24b0059f47c272b619ba560375974.png" src="../../_images/e3986286fc17a8d4530a0e8e143ef96054f24b0059f47c272b619ba560375974.png" />
</div>
</div>
<p>注：各ステージは必ずしも独立して実行できるわけではありません（前のステージから情報を引き継ぐ必要がある場合があります）。</p>
</section>
<section id="id9">
<h3>3.4 最適化ステージ<a class="headerlink" href="#id9" title="Link to this heading">#</a></h3>
<p>パイプラインの最後のデフォルトステージは最適化です。ターゲット用に回路を埋め込んだ後、回路はかなり膨らみます。これは主に基底変換やSWAP挿入による非効率性が原因です。最適化ステージでは、回路のサイズや深さを最小化するために一連のパスを<code class="docutils literal notranslate"><span class="pre">do</span> <span class="pre">while</span></code>ループで実行し、出力が安定するまで繰り返します。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># pm.pre_optimization.draw()</span>
<span class="n">pm</span><span class="o">.</span><span class="n">optimization</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/cae58dd97778376b4809d54d07f78ab077c2fb2aefa395b62c7cc766f5d0f2c5.png" src="../../_images/cae58dd97778376b4809d54d07f78ab077c2fb2aefa395b62c7cc766f5d0f2c5.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="s2">&quot;INFO&quot;</span><span class="p">)</span>
<span class="n">opt_out</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">optimization</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">basis_out</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:qiskit.passmanager.base_tasks:Pass: Depth - 0.04721 (ms)
INFO:qiskit.passmanager.base_tasks:Pass: FixedPoint - 0.02098 (ms)
INFO:qiskit.passmanager.base_tasks:Pass: Size - 0.01407 (ms)
INFO:qiskit.passmanager.base_tasks:Pass: FixedPoint - 0.00691 (ms)
INFO:qiskit.passmanager.base_tasks:Pass: Optimize1qGatesDecomposition - 0.26321 (ms)
INFO:qiskit.passmanager.base_tasks:Pass: InverseCancellation - 0.29802 (ms)
INFO:qiskit.passmanager.base_tasks:Pass: ContractIdleWiresInControlFlow - 0.00811 (ms)
INFO:qiskit.passmanager.base_tasks:Pass: GatesInBasis - 0.03695 (ms)
INFO:qiskit.passmanager.base_tasks:Pass: Depth - 0.02408 (ms)
INFO:qiskit.passmanager.base_tasks:Pass: FixedPoint - 0.00691 (ms)
INFO:qiskit.passmanager.base_tasks:Pass: Size - 0.00691 (ms)
INFO:qiskit.passmanager.base_tasks:Pass: FixedPoint - 0.00501 (ms)
INFO:qiskit.passmanager.base_tasks:Pass: Optimize1qGatesDecomposition - 0.13399 (ms)
INFO:qiskit.passmanager.base_tasks:Pass: InverseCancellation - 0.08392 (ms)
INFO:qiskit.passmanager.base_tasks:Pass: ContractIdleWiresInControlFlow - 0.00119 (ms)
INFO:qiskit.passmanager.base_tasks:Pass: GatesInBasis - 0.01502 (ms)
INFO:qiskit.passmanager.base_tasks:Pass: Depth - 0.02217 (ms)
INFO:qiskit.passmanager.base_tasks:Pass: FixedPoint - 0.00310 (ms)
INFO:qiskit.passmanager.base_tasks:Pass: Size - 0.00310 (ms)
INFO:qiskit.passmanager.base_tasks:Pass: FixedPoint - 0.00310 (ms)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">opt_out</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="s2">&quot;mpl&quot;</span><span class="p">,</span> <span class="n">idle_wires</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fold</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/2e4a05dfcf5c082fcfb840f00e0eefdef0c9597d540b91ca947cdaa4132e5b32.png" src="../../_images/2e4a05dfcf5c082fcfb840f00e0eefdef0c9597d540b91ca947cdaa4132e5b32.png" />
</div>
</div>
</section>
</section>
<section id="id10">
<h2>4. 詳細な例<a class="headerlink" href="#id10" title="Link to this heading">#</a></h2>
<section id="id11">
<h3>4.1 2量子ビットブロック最適化（2量子ビットユニタリー合成）<a class="headerlink" href="#id11" title="Link to this heading">#</a></h3>
<p>レベル2・3では、より多くのパス（<code class="docutils literal notranslate"><span class="pre">Collect2qBlocks</span></code>, <code class="docutils literal notranslate"><span class="pre">ConsolidateBlocks</span></code>, <code class="docutils literal notranslate"><span class="pre">UnitarySynthesis</span></code>）による最適化、すなわち2量子ビットブロック最適化が行われます。（レベル1の最適化ステージと比較してください）</p>
<p>2量子ビットブロック最適化は、2量子ビットブロックの収集・統合と、2量子ビットユニタリ行列の合成の2ステップで構成されます。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pm2</span> <span class="o">=</span> <span class="n">generate_preset_pass_manager</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">backend</span><span class="p">,</span> <span class="n">seed_transpiler</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">pm2</span><span class="o">.</span><span class="n">optimization</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/11ec9d37d781a6ea0565c056534ffec8ff9b447ca0952be6dbd1c11afb2db886.png" src="../../_images/11ec9d37d781a6ea0565c056534ffec8ff9b447ca0952be6dbd1c11afb2db886.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">qiskit.transpiler</span><span class="w"> </span><span class="kn">import</span> <span class="n">PassManager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">qiskit.transpiler.passes</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Collect2qBlocks</span><span class="p">,</span>
    <span class="n">ConsolidateBlocks</span><span class="p">,</span>
    <span class="n">UnitarySynthesis</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Collect 2q blocks and consolidate to unitary when we expect that we can reduce the 2q gate count for that unitary</span>
<span class="n">consolidate_pm</span> <span class="o">=</span> <span class="n">PassManager</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">Collect2qBlocks</span><span class="p">(),</span>
        <span class="n">ConsolidateBlocks</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">target</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display</span><span class="p">(</span><span class="n">basis_out</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="s2">&quot;mpl&quot;</span><span class="p">,</span> <span class="n">idle_wires</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fold</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>

<span class="n">consolidated</span> <span class="o">=</span> <span class="n">consolidate_pm</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">basis_out</span><span class="p">)</span>
<span class="n">consolidated</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="s2">&quot;mpl&quot;</span><span class="p">,</span> <span class="n">idle_wires</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fold</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/e3986286fc17a8d4530a0e8e143ef96054f24b0059f47c272b619ba560375974.png" src="../../_images/e3986286fc17a8d4530a0e8e143ef96054f24b0059f47c272b619ba560375974.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:qiskit.passmanager.base_tasks:Pass: Collect2qBlocks - 0.06080 (ms)
INFO:qiskit.passmanager.base_tasks:Pass: ConsolidateBlocks - 0.16904 (ms)
</pre></div>
</div>
<img alt="../../_images/70ede3ddec8bf1bd03afa156c026b90420daac4340a07134045eac0814a1d0bc.png" src="../../_images/70ede3ddec8bf1bd03afa156c026b90420daac4340a07134045eac0814a1d0bc.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Synthesize unitaries</span>
<span class="n">UnitarySynthesis</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">target</span><span class="p">)(</span><span class="n">consolidated</span><span class="p">)</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span>
    <span class="s2">&quot;mpl&quot;</span><span class="p">,</span> <span class="n">idle_wires</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fold</span><span class="o">=-</span><span class="mi">1</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:qiskit.passmanager.base_tasks:Pass: UnitarySynthesis - 0.74816 (ms)
</pre></div>
</div>
<img alt="../../_images/10ee80e8454f40c50b034441a2b800b71d203ed42cc5527c34ff1ff65f6eae0a.png" src="../../_images/10ee80e8454f40c50b034441a2b800b71d203ed42cc5527c34ff1ff65f6eae0a.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="s2">&quot;WARNING&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>パート2で見たように、実際の量子コンパイラのフローは非常に多くのパス（タスク）で構成されています。これは、幅広い応用回路に対する性能やソフトウェアの保守性を確保するためのソフトウェア工学的な理由によるものです。Qiskitトランスパイラは多くの場合うまく動作しますが、もし自分の回路が十分に最適化されない場合は、パート1で示したような応用特化型の回路最適化を研究する良い機会です。トランスパイラ技術は進化中ですので、皆さんのR&amp;Dの貢献も歓迎します。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">qiskit.circuit</span><span class="w"> </span><span class="kn">import</span> <span class="n">QuantumCircuit</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">qiskit_ibm_runtime</span><span class="w"> </span><span class="kn">import</span> <span class="n">QiskitRuntimeService</span><span class="p">,</span> <span class="n">Sampler</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">service</span> <span class="o">=</span> <span class="n">QiskitRuntimeService</span><span class="p">()</span>
<span class="n">backend</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">backend</span><span class="p">(</span><span class="s2">&quot;ibm_brisbane&quot;</span><span class="p">)</span>
<span class="n">sampler</span> <span class="o">=</span> <span class="n">Sampler</span><span class="p">(</span><span class="n">backend</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">circ</span> <span class="o">=</span> <span class="n">QuantumCircuit</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">circ</span><span class="o">.</span><span class="n">ccx</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">circ</span><span class="o">.</span><span class="n">measure_all</span><span class="p">()</span>
<span class="n">circ</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="s2">&quot;mpl&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/f2740779c9440fd1617acc12905da429333c1394dbaa22df84ca6f5abed55556.png" src="../../_images/f2740779c9440fd1617acc12905da429333c1394dbaa22df84ca6f5abed55556.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sampler</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">circ</span><span class="p">])</span>  <span class="c1"># IBMInputValueError will be raised</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">IBMInputValueError</span><span class="g g-Whitespace">                        </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">39</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">sampler</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">circ</span><span class="p">])</span>  <span class="c1"># IBMInputValueError will be raised</span>

<span class="nn">File ~/workspace/quantum/introduction/.venv/lib/python3.11/site-packages/qiskit_ibm_runtime/sampler.py:111,</span> in <span class="ni">SamplerV2.run</span><span class="nt">(self, pubs, shots)</span>
<span class="g g-Whitespace">    </span><span class="mi">107</span> <span class="n">coerced_pubs</span> <span class="o">=</span> <span class="p">[</span><span class="n">SamplerPub</span><span class="o">.</span><span class="n">coerce</span><span class="p">(</span><span class="n">pub</span><span class="p">,</span> <span class="n">shots</span><span class="p">)</span> <span class="k">for</span> <span class="n">pub</span> <span class="ow">in</span> <span class="n">pubs</span><span class="p">]</span>
<span class="g g-Whitespace">    </span><span class="mi">109</span> <span class="n">validate_classical_registers</span><span class="p">(</span><span class="n">coerced_pubs</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">111</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run</span><span class="p">(</span><span class="n">coerced_pubs</span><span class="p">)</span>

<span class="nn">File ~/workspace/quantum/introduction/.venv/lib/python3.11/site-packages/qiskit_ibm_runtime/base_primitive.py:149,</span> in <span class="ni">BasePrimitiveV2._run</span><span class="nt">(self, pubs)</span>
<span class="g g-Whitespace">    </span><span class="mi">147</span> <span class="k">for</span> <span class="n">pub</span> <span class="ow">in</span> <span class="n">pubs</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">148</span>     <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="p">,</span> <span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_simulator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">149</span>         <span class="n">validate_isa_circuits</span><span class="p">([</span><span class="n">pub</span><span class="o">.</span><span class="n">circuit</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">151</span>     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="p">,</span> <span class="n">IBMBackend</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">152</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">check_faulty</span><span class="p">(</span><span class="n">pub</span><span class="o">.</span><span class="n">circuit</span><span class="p">)</span>

<span class="nn">File ~/workspace/quantum/introduction/.venv/lib/python3.11/site-packages/qiskit_ibm_runtime/utils/validations.py:96,</span> in <span class="ni">validate_isa_circuits</span><span class="nt">(circuits, target)</span>
<span class="g g-Whitespace">     </span><span class="mi">94</span> <span class="n">message</span> <span class="o">=</span> <span class="n">is_isa_circuit</span><span class="p">(</span><span class="n">circuit</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">95</span> <span class="k">if</span> <span class="n">message</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">96</span>     <span class="k">raise</span> <span class="n">IBMInputValueError</span><span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">97</span>         <span class="n">message</span>
<span class="g g-Whitespace">     </span><span class="mi">98</span>         <span class="o">+</span> <span class="s2">&quot; Circuits that do not match the target hardware definition are no longer &quot;</span>
<span class="g g-Whitespace">     </span><span class="mi">99</span>         <span class="s2">&quot;supported after March 4, 2024. See the transpilation documentation &quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">100</span>         <span class="s2">&quot;(https://quantum.cloud.ibm.com/docs/guides/transpile) for instructions &quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">101</span>         <span class="s2">&quot;to transform circuits and the primitive examples &quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">102</span>         <span class="s2">&quot;(https://quantum.cloud.ibm.com/docs/guides/primitives-examples) to see &quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">103</span>         <span class="s2">&quot;this coupled with operator transformations.&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">104</span>     <span class="p">)</span>

<span class="ne">IBMInputValueError</span>: &#39;The instruction ccx on qubits (0, 1, 2) is not supported by the target system. Circuits that do not match the target hardware definition are no longer supported after March 4, 2024. See the transpilation documentation (https://quantum.cloud.ibm.com/docs/guides/transpile) for instructions to transform circuits and the primitive examples (https://quantum.cloud.ibm.com/docs/guides/primitives-examples) to see this coupled with operator transformations.&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="id12">
<h3>4.2 回路最適化の重要性<a class="headerlink" href="#id12" title="Link to this heading">#</a></h3>
<p>まず、最適化あり・なしで5量子ビットGHZ状態（<span class="math notranslate nohighlight">\(\frac{1}{\sqrt{2}} \left( |00000\rangle + |11111\rangle \right)\)</span>）生成回路の実行結果を比較します。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">qiskit.circuit</span><span class="w"> </span><span class="kn">import</span> <span class="n">QuantumCircuit</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">qiskit.transpiler.preset_passmanagers</span><span class="w"> </span><span class="kn">import</span> <span class="n">generate_preset_pass_manager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">qiskit_ibm_runtime</span><span class="w"> </span><span class="kn">import</span> <span class="n">QiskitRuntimeService</span><span class="p">,</span> <span class="n">Sampler</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">service</span> <span class="o">=</span> <span class="n">QiskitRuntimeService</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># backend = service.backend(&#39;ibm_brisbane&#39;)</span>
<span class="n">backend</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">least_busy</span><span class="p">(</span>
    <span class="n">operational</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">simulator</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">min_num_qubits</span><span class="o">=</span><span class="mi">127</span>
<span class="p">)</span>  <span class="c1"># Eagle</span>
<span class="n">backend</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;IBMBackend(&#39;ibm_brisbane&#39;)&gt;
</pre></div>
</div>
</div>
</div>
<p>まず、以下のように素朴に合成したGHZ回路を使います。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_qubits</span> <span class="o">=</span> <span class="mi">5</span>

<span class="n">ghz_circ</span> <span class="o">=</span> <span class="n">QuantumCircuit</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">)</span>
<span class="n">ghz_circ</span><span class="o">.</span><span class="n">h</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="p">[</span><span class="n">ghz_circ</span><span class="o">.</span><span class="n">cx</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_qubits</span><span class="p">)]</span>
<span class="n">ghz_circ</span><span class="o">.</span><span class="n">measure_all</span><span class="p">()</span>
<span class="n">ghz_circ</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="s2">&quot;mpl&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/328007675e4984199d0155c55e78f87cd4169480556e7493a3b5295977b428ac.png" src="../../_images/328007675e4984199d0155c55e78f87cd4169480556e7493a3b5295977b428ac.png" />
</div>
</div>
<p>回路を最適化なし（<code class="docutils literal notranslate"><span class="pre">optimization_level=0</span></code>）と最適化あり（<code class="docutils literal notranslate"><span class="pre">optimization_level=2</span></code>）でトランスパイルします。
ご覧の通り、トランスパイル後の回路長に大きな違いがあります。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pm0</span> <span class="o">=</span> <span class="n">generate_preset_pass_manager</span><span class="p">(</span>
    <span class="n">optimization_level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">,</span> <span class="n">seed_transpiler</span><span class="o">=</span><span class="mi">777</span>
<span class="p">)</span>
<span class="n">pm2</span> <span class="o">=</span> <span class="n">generate_preset_pass_manager</span><span class="p">(</span>
    <span class="n">optimization_level</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">,</span> <span class="n">seed_transpiler</span><span class="o">=</span><span class="mi">777</span>
<span class="p">)</span>
<span class="n">circ0</span> <span class="o">=</span> <span class="n">pm0</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">ghz_circ</span><span class="p">)</span>
<span class="n">circ2</span> <span class="o">=</span> <span class="n">pm2</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">ghz_circ</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;optimization_level=0:&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">circ0</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="s2">&quot;mpl&quot;</span><span class="p">,</span> <span class="n">idle_wires</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fold</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;optimization_level=2:&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">circ2</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="s2">&quot;mpl&quot;</span><span class="p">,</span> <span class="n">idle_wires</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fold</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>optimization_level=0:
</pre></div>
</div>
<img alt="../../_images/e2c82943bf3a51cfdee48048d3844d2c874f8bea55b2ca1882f2beeae090941e.png" src="../../_images/e2c82943bf3a51cfdee48048d3844d2c874f8bea55b2ca1882f2beeae090941e.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>optimization_level=2:
</pre></div>
</div>
<img alt="../../_images/d9cc951037c2924bebf0dc7abbad71d3bcf9c77fb40f5e319670c6b17c69563b.png" src="../../_images/d9cc951037c2924bebf0dc7abbad71d3bcf9c77fb40f5e319670c6b17c69563b.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># run the circuits</span>
<span class="n">sampler</span> <span class="o">=</span> <span class="n">Sampler</span><span class="p">(</span><span class="n">backend</span><span class="p">)</span>
<span class="n">job</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">circ0</span><span class="p">,</span> <span class="n">circ2</span><span class="p">],</span> <span class="n">shots</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
<span class="n">job_id</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job ID: </span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Job ID: d2g4kil0d2ps738vn0jg
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># REPLACE WITH YOUR OWN JOB IDS</span>
<span class="n">job</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">job</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># get results</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
<span class="n">unoptimized_result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">meas</span><span class="o">.</span><span class="n">get_counts</span><span class="p">()</span>
<span class="n">optimized_result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">meas</span><span class="o">.</span><span class="n">get_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">qiskit.visualization</span><span class="w"> </span><span class="kn">import</span> <span class="n">plot_histogram</span>

<span class="c1"># plot</span>
<span class="n">sim_result</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;0&quot;</span> <span class="o">*</span> <span class="mi">5</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span> <span class="o">*</span> <span class="mi">5</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">}</span>
<span class="n">plot_histogram</span><span class="p">(</span>
    <span class="p">[</span><span class="n">result</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="p">[</span><span class="n">sim_result</span><span class="p">,</span> <span class="n">unoptimized_result</span><span class="p">,</span> <span class="n">optimized_result</span><span class="p">]],</span>
    <span class="n">bar_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">legend</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;ideal&quot;</span><span class="p">,</span>
        <span class="s2">&quot;no optimization&quot;</span><span class="p">,</span>
        <span class="s2">&quot;with optimization&quot;</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/cc868dd59a7765e381c562be8d1a56ddbfe9f385ef5b32b3e66918cb48316054.png" src="../../_images/cc868dd59a7765e381c562be8d1a56ddbfe9f385ef5b32b3e66918cb48316054.png" />
</div>
</div>
</section>
<section id="id13">
<h3>4.3 回路合成の重要性<a class="headerlink" href="#id13" title="Link to this heading">#</a></h3>
<p>次に、2通りの合成方法で作った5量子ビットGHZ状態（<span class="math notranslate nohighlight">\(\frac{1}{\sqrt{2}} \left( |00000\rangle + |11111\rangle \right)\)</span>）生成回路の実行結果を比較します。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Original GHZ circuit (naive synthesis)</span>
<span class="n">ghz_circ</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="s2">&quot;mpl&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/328007675e4984199d0155c55e78f87cd4169480556e7493a3b5295977b428ac.png" src="../../_images/328007675e4984199d0155c55e78f87cd4169480556e7493a3b5295977b428ac.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># A better GHZ circuit (smarter synthesis), you learned in a previous lecture</span>
<span class="n">ghz_circ2</span> <span class="o">=</span> <span class="n">QuantumCircuit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">ghz_circ2</span><span class="o">.</span><span class="n">h</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ghz_circ2</span><span class="o">.</span><span class="n">cx</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">ghz_circ2</span><span class="o">.</span><span class="n">cx</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">ghz_circ2</span><span class="o">.</span><span class="n">cx</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">ghz_circ2</span><span class="o">.</span><span class="n">cx</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">ghz_circ2</span><span class="o">.</span><span class="n">measure_all</span><span class="p">()</span>
<span class="n">ghz_circ2</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="s2">&quot;mpl&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/0c607532f8d71c5ffa4a644dae59290e28197fee4bceacb0d750a031b0955929.png" src="../../_images/0c607532f8d71c5ffa4a644dae59290e28197fee4bceacb0d750a031b0955929.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">circ_org</span> <span class="o">=</span> <span class="n">pm2</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">ghz_circ</span><span class="p">)</span>
<span class="n">circ_new</span> <span class="o">=</span> <span class="n">pm2</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">ghz_circ2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;original synthesis:&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">circ_org</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="s2">&quot;mpl&quot;</span><span class="p">,</span> <span class="n">idle_wires</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fold</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;new synthesis:&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">circ_new</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="s2">&quot;mpl&quot;</span><span class="p">,</span> <span class="n">idle_wires</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fold</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>original synthesis:
</pre></div>
</div>
<img alt="../../_images/d9cc951037c2924bebf0dc7abbad71d3bcf9c77fb40f5e319670c6b17c69563b.png" src="../../_images/d9cc951037c2924bebf0dc7abbad71d3bcf9c77fb40f5e319670c6b17c69563b.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>new synthesis:
</pre></div>
</div>
<img alt="../../_images/4f9ff035823d57dc2094d82035f76bdba109c62e68dbb0431276e2312d00a771.png" src="../../_images/4f9ff035823d57dc2094d82035f76bdba109c62e68dbb0431276e2312d00a771.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># run the circuits</span>
<span class="n">sampler</span> <span class="o">=</span> <span class="n">Sampler</span><span class="p">(</span><span class="n">backend</span><span class="p">)</span>
<span class="n">job</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">circ_org</span><span class="p">,</span> <span class="n">circ_new</span><span class="p">],</span> <span class="n">shots</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
<span class="n">job_id</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job ID: </span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Job ID: d2g4kqt0d2ps738vn0r0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># REPLACE WITH YOUR OWN JOB IDS</span>
<span class="n">job</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">job</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># get results</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
<span class="n">synthesis_org_result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">meas</span><span class="o">.</span><span class="n">get_counts</span><span class="p">()</span>
<span class="n">synthesis_new_result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">meas</span><span class="o">.</span><span class="n">get_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot</span>
<span class="n">sim_result</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;0&quot;</span> <span class="o">*</span> <span class="mi">5</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span> <span class="o">*</span> <span class="mi">5</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">}</span>
<span class="n">plot_histogram</span><span class="p">(</span>
    <span class="p">[</span><span class="n">result</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="p">[</span><span class="n">sim_result</span><span class="p">,</span> <span class="n">synthesis_org_result</span><span class="p">,</span> <span class="n">synthesis_new_result</span><span class="p">]],</span>
    <span class="n">bar_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">legend</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;ideal&quot;</span><span class="p">,</span>
        <span class="s2">&quot;synthesis_org&quot;</span><span class="p">,</span>
        <span class="s2">&quot;synthesis_new&quot;</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/82d5328cb373798e09779d63f45085ca7759d22dbc054031d7504ca921957ea7.png" src="../../_images/82d5328cb373798e09779d63f45085ca7759d22dbc054031d7504ca921957ea7.png" />
</div>
</div>
</section>
<section id="id14">
<h3>4.4 一般的な1量子ビットゲート分解<a class="headerlink" href="#id14" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">qiskit</span><span class="w"> </span><span class="kn">import</span> <span class="n">QuantumCircuit</span><span class="p">,</span> <span class="n">transpile</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">qiskit.circuit</span><span class="w"> </span><span class="kn">import</span> <span class="n">Parameter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">qiskit.circuit.library.standard_gates</span><span class="w"> </span><span class="kn">import</span> <span class="n">UGate</span>

<span class="n">phi</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">lam</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="s2">&quot;φ&quot;</span><span class="p">),</span> <span class="n">Parameter</span><span class="p">(</span><span class="s2">&quot;θ&quot;</span><span class="p">),</span> <span class="n">Parameter</span><span class="p">(</span><span class="s2">&quot;λ&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">qc</span> <span class="o">=</span> <span class="n">QuantumCircuit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">qc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">UGate</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">lam</span><span class="p">),</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">qc</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="s2">&quot;mpl&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/e0f457ed0cca391fca06e90b7097adb5b7692a62458bdc91c0c39ea58db41b6b.png" src="../../_images/e0f457ed0cca391fca06e90b7097adb5b7692a62458bdc91c0c39ea58db41b6b.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">transpile</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="n">basis_gates</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;rz&quot;</span><span class="p">,</span> <span class="s2">&quot;sx&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="s2">&quot;mpl&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/7496b653b43bec8ffdb3a90606d2708306eb99fb9f435323a96885811af10931.png" src="../../_images/7496b653b43bec8ffdb3a90606d2708306eb99fb9f435323a96885811af10931.png" />
</div>
</div>
</section>
<section id="id15">
<h3>4.5 1量子ビットブロック最適化<a class="headerlink" href="#id15" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">qiskit</span><span class="w"> </span><span class="kn">import</span> <span class="n">QuantumCircuit</span>

<span class="n">qc</span> <span class="o">=</span> <span class="n">QuantumCircuit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">qc</span><span class="o">.</span><span class="n">x</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">qc</span><span class="o">.</span><span class="n">y</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">qc</span><span class="o">.</span><span class="n">z</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">qc</span><span class="o">.</span><span class="n">rx</span><span class="p">(</span><span class="mf">1.23</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">qc</span><span class="o">.</span><span class="n">ry</span><span class="p">(</span><span class="mf">1.23</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">qc</span><span class="o">.</span><span class="n">rz</span><span class="p">(</span><span class="mf">1.23</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">qc</span><span class="o">.</span><span class="n">h</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">qc</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">qc</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">qc</span><span class="o">.</span><span class="n">sx</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">qc</span><span class="o">.</span><span class="n">sdg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">qc</span><span class="o">.</span><span class="n">tdg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">qc</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="s2">&quot;mpl&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/2b38cafb39faa92a5ccfb4f09908dee80468d7a96bccf65be26ab96235bce7d6.png" src="../../_images/2b38cafb39faa92a5ccfb4f09908dee80468d7a96bccf65be26ab96235bce7d6.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">qiskit.quantum_info</span><span class="w"> </span><span class="kn">import</span> <span class="n">Operator</span>

<span class="n">Operator</span><span class="p">(</span><span class="n">qc</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Operator([[ 0.45292511-0.57266982j, -0.66852684-0.14135058j],
          [ 0.14135058+0.66852684j, -0.57266982+0.45292511j]],
         input_dims=(2,), output_dims=(2,))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">qiskit</span><span class="w"> </span><span class="kn">import</span> <span class="n">transpile</span>

<span class="n">qc_opt</span> <span class="o">=</span> <span class="n">transpile</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="n">basis_gates</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;rz&quot;</span><span class="p">,</span> <span class="s2">&quot;sx&quot;</span><span class="p">])</span>
<span class="n">qc_opt</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="s2">&quot;mpl&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/ac59c2a696856da3cea17fabaf2981c3810ff889bc16400a96a8987cd3282b45.png" src="../../_images/ac59c2a696856da3cea17fabaf2981c3810ff889bc16400a96a8987cd3282b45.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Operator</span><span class="p">(</span><span class="n">qc_opt</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Operator([[ 0.45292511-0.57266982j, -0.66852684-0.14135058j],
          [ 0.14135058+0.66852684j, -0.57266982+0.45292511j]],
         input_dims=(2,), output_dims=(2,))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Operator</span><span class="p">(</span><span class="n">qc</span><span class="p">)</span><span class="o">.</span><span class="n">equiv</span><span class="p">(</span><span class="n">Operator</span><span class="p">(</span><span class="n">qc_opt</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
</section>
<section id="id16">
<h3>4.6 トフォリ分解<a class="headerlink" href="#id16" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">qc</span> <span class="o">=</span> <span class="n">QuantumCircuit</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">qc</span><span class="o">.</span><span class="n">ccx</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">qc</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="s2">&quot;mpl&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/4a44534e49f90ccecd3d7aa03c68ed9524cbbed1869187589e9f9cd67d0546c1.png" src="../../_images/4a44534e49f90ccecd3d7aa03c68ed9524cbbed1869187589e9f9cd67d0546c1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">qiskit</span><span class="w"> </span><span class="kn">import</span> <span class="n">QuantumCircuit</span><span class="p">,</span> <span class="n">transpile</span>

<span class="n">qc</span> <span class="o">=</span> <span class="n">QuantumCircuit</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">qc</span><span class="o">.</span><span class="n">ccx</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">qc</span> <span class="o">=</span> <span class="n">transpile</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="n">basis_gates</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;rz&quot;</span><span class="p">,</span> <span class="s2">&quot;sx&quot;</span><span class="p">,</span> <span class="s2">&quot;cx&quot;</span><span class="p">])</span>
<span class="n">qc</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="s2">&quot;mpl&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/ae4cff314a080b66e8494e14bf6ad958b98e2bff7b322a79bdbd5acdbaec020a.png" src="../../_images/ae4cff314a080b66e8494e14bf6ad958b98e2bff7b322a79bdbd5acdbaec020a.png" />
</div>
</div>
</section>
<section id="cu">
<h3>4.7 CUゲート分解<a class="headerlink" href="#cu" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">qiskit.circuit.library.standard_gates</span><span class="w"> </span><span class="kn">import</span> <span class="n">CUGate</span>

<span class="n">phi</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">lam</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="s2">&quot;φ&quot;</span><span class="p">),</span> <span class="n">Parameter</span><span class="p">(</span><span class="s2">&quot;θ&quot;</span><span class="p">),</span> <span class="n">Parameter</span><span class="p">(</span><span class="s2">&quot;λ&quot;</span><span class="p">),</span> <span class="n">Parameter</span><span class="p">(</span><span class="s2">&quot;γ&quot;</span><span class="p">)</span>
<span class="n">qc</span> <span class="o">=</span> <span class="n">QuantumCircuit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># qc.cu(theta, phi, lam, gamma, 0, 1)</span>
<span class="n">qc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CUGate</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">lam</span><span class="p">,</span> <span class="n">gamma</span><span class="p">),</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">qc</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="s2">&quot;mpl&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/751dab5e1704092c9daa6d4c766d942197dfc2d8ac992387641f3cca050e8ce3.png" src="../../_images/751dab5e1704092c9daa6d4c766d942197dfc2d8ac992387641f3cca050e8ce3.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">qiskit.circuit.library.standard_gates</span><span class="w"> </span><span class="kn">import</span> <span class="n">CUGate</span>

<span class="n">phi</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">lam</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="s2">&quot;φ&quot;</span><span class="p">),</span> <span class="n">Parameter</span><span class="p">(</span><span class="s2">&quot;θ&quot;</span><span class="p">),</span> <span class="n">Parameter</span><span class="p">(</span><span class="s2">&quot;λ&quot;</span><span class="p">),</span> <span class="n">Parameter</span><span class="p">(</span><span class="s2">&quot;γ&quot;</span><span class="p">)</span>
<span class="n">qc</span> <span class="o">=</span> <span class="n">QuantumCircuit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">qc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CUGate</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">lam</span><span class="p">,</span> <span class="n">gamma</span><span class="p">),</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">qc</span> <span class="o">=</span> <span class="n">transpile</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="n">basis_gates</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;rz&quot;</span><span class="p">,</span> <span class="s2">&quot;sx&quot;</span><span class="p">,</span> <span class="s2">&quot;cx&quot;</span><span class="p">])</span>
<span class="n">qc</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="s2">&quot;mpl&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/5c8ea8626f2bebc222810c7711f293ad0f4eb2dcc652d9b8b8c0f4bcbe22c88b.png" src="../../_images/5c8ea8626f2bebc222810c7711f293ad0f4eb2dcc652d9b8b8c0f4bcbe22c88b.png" />
</div>
</div>
</section>
<section id="cx-ecr-czclifford">
<h3>4.8 CX, ECR, CZはローカルClifford変換で等価<a class="headerlink" href="#cx-ecr-czclifford" title="Link to this heading">#</a></h3>
<p><span class="math notranslate nohighlight">\(H\)</span>(アダマール)、<span class="math notranslate nohighlight">\(S\)</span>（<span class="math notranslate nohighlight">\(\pi/2\)</span> Z回転）、<span class="math notranslate nohighlight">\(S^\dagger\)</span>（<span class="math notranslate nohighlight">\(-\pi/2\)</span> Z回転）、<span class="math notranslate nohighlight">\(X\)</span>（パウリX）はすべてCliffordゲートです。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">qc</span> <span class="o">=</span> <span class="n">QuantumCircuit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">qc</span><span class="o">.</span><span class="n">cx</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">qc</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="s2">&quot;mpl&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;bw&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/b0b02e0d527ae72a6fecfc2c5052e45a132507567f96543142880ba4d485b9b4.png" src="../../_images/b0b02e0d527ae72a6fecfc2c5052e45a132507567f96543142880ba4d485b9b4.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">qc</span> <span class="o">=</span> <span class="n">QuantumCircuit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">qc</span><span class="o">.</span><span class="n">cx</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">transpile</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="n">basis_gates</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="s2">&quot;h&quot;</span><span class="p">,</span> <span class="s2">&quot;sdg&quot;</span><span class="p">,</span> <span class="s2">&quot;ecr&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="s2">&quot;mpl&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;bw&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/090959ae750e7bf34f00e521bd872fe60d84cd829ddb284180c8982b68bf626c.png" src="../../_images/090959ae750e7bf34f00e521bd872fe60d84cd829ddb284180c8982b68bf626c.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">qc</span> <span class="o">=</span> <span class="n">QuantumCircuit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">qc</span><span class="o">.</span><span class="n">cx</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">transpile</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="n">basis_gates</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;h&quot;</span><span class="p">,</span> <span class="s2">&quot;cz&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="s2">&quot;mpl&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;bw&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/d9e4b1f30bf9a8c3505d6247e6e167ba61a2b59c25b9e47ebdccfbcbd8d71894.png" src="../../_images/d9e4b1f30bf9a8c3505d6247e6e167ba61a2b59c25b9e47ebdccfbcbd8d71894.png" />
</div>
</div>
<p>IBMバックエンドの1量子ビット基底ゲート「rz」「sx」「x」を使用します。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">qc</span> <span class="o">=</span> <span class="n">QuantumCircuit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">qc</span><span class="o">.</span><span class="n">cx</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">transpile</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="n">basis_gates</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;rz&quot;</span><span class="p">,</span> <span class="s2">&quot;sx&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;ecr&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="s2">&quot;mpl&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;bw&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/ed1f5d763844f88a72a4bd8f171a38f81913b8cc6f1059e78f2338ca30274d2c.png" src="../../_images/ed1f5d763844f88a72a4bd8f171a38f81913b8cc6f1059e78f2338ca30274d2c.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">qc</span> <span class="o">=</span> <span class="n">QuantumCircuit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">qc</span><span class="o">.</span><span class="n">cx</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">transpile</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="n">basis_gates</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;rz&quot;</span><span class="p">,</span> <span class="s2">&quot;sx&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;cz&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="s2">&quot;mpl&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;bw&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/7170b13595f3be9a33e412663a6d197642ca87fc39809533cecd2df25fed957c.png" src="../../_images/7170b13595f3be9a33e412663a6d197642ca87fc39809533cecd2df25fed957c.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check Qiskit version</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">qiskit</span>

<span class="n">qiskit</span><span class="o">.</span><span class="n">__version__</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;2.1.1&#39;
</pre></div>
</div>
</div>
</div>
<p>© IBM Corp., 2017-2025</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./courses/utility-scale-quantum-computing"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">1. はじめに</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">2. 回路最適化の重要性</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">2.1 最適化レベル</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">2.2 演習</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">3. 回路合成の重要性</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#qiskit">3.1 Qiskitトランスパイル全体の流れを描画</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">3.2 個別ステージの描画</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">3.3 演習</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">3.4 最適化ステージ</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">4. 詳細な例</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id11">4.1 2量子ビットブロック最適化（2量子ビットユニタリー合成）</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id12">4.2 回路最適化の重要性</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id13">4.3 回路合成の重要性</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id14">4.4 一般的な1量子ビットゲート分解</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id15">4.5 1量子ビットブロック最適化</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id16">4.6 トフォリ分解</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cu">4.7 CUゲート分解</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cx-ecr-czclifford">4.8 CX, ECR, CZはローカルClifford変換で等価</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Quantum Tokyo
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright Quantum Tokyo 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>